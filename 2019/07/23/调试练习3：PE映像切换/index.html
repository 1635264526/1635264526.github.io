<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="chinese">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="先运行某个进程 然后将其虚拟内存中的PE映像切换到另外一个映像 这称为PE映像切换">
<meta property="og:type" content="article">
<meta property="og:title" content="调试练习3：PE映像切换">
<meta property="og:url" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/index.html">
<meta property="og:site_name" content="loser的博客">
<meta property="og:description" content="先运行某个进程 然后将其虚拟内存中的PE映像切换到另外一个映像 这称为PE映像切换">
<meta property="og:locale" content="chinese">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/1.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/2.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/3.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/4.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/5.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/6.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/7.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/8.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/9.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/10.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/11.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/12.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/13.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/14.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/15.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/16.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/17.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/18.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/19.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/20.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/21.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/22.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/23.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/24.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/25.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/26.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/27.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/27.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/28.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/29.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/30.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/31.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/32.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/33.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/34.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/35.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/36.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/37.png">
<meta property="og:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/38.png">
<meta property="og:updated_time" content="2019-07-23T09:10:36.507Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="调试练习3：PE映像切换">
<meta name="twitter:description" content="先运行某个进程 然后将其虚拟内存中的PE映像切换到另外一个映像 这称为PE映像切换">
<meta name="twitter:image" content="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/">





  <title>调试练习3：PE映像切换 | loser的博客</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="chinese">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">loser的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/23/调试练习3：PE映像切换/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="loser">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="loser的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">调试练习3：PE映像切换</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-23T08:51:06+08:00">
                2019-07-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>先运行某个进程 然后将其虚拟内存中的PE映像切换到另外一个映像 这称为PE映像切换</p>
<a id="more"></a>
<h1 id="PE映像"><a href="#PE映像" class="headerlink" title="PE映像"></a>PE映像</h1><p>代码逆向分析中有个常用术语为“PE映像”(或者Process Image(进程映像)或Image(映像))。简言之，“PE映像”就是PE文件在进程内存中的映射形态( 参考下图 )。</p>
<p><img src="1.png" alt=""><br>PE文件( notepad.exe )以进程形式运行时，其进程的虚拟内存如上图所示。OS先为进程开辟虚拟内存空间，然后将notepad.exe文 件映射到USER内存空间，并且notepad.exe中使用的导出DLL文件( kernel32.dll、user32.dll、 gdi32.dIl等)也会依次映射进来。此时映射在进程USER内存空间中的Notepad.exe区域称为( notepad.exe文件的) PE映像。PE文件与PE映像形态不同，差异如下图.</p>
<p>一般而言，PE文件①File Alignment (文件对齐)与Section Alignment (节区对齐)是不同的，②各节区中的Raw Data Size ( 原始数据大小)与Virtual Size ( 虚拟大小)也是不同的，所以PE文件与PE映像在形态上会有不同，如下图所示。</p>
<p><img src="2.png" alt=""></p>
<h1 id="PE映像切换"><a href="#PE映像切换" class="headerlink" title="PE映像切换"></a>PE映像切换</h1><p>PE映像切换是种非常神奇的技术，应用时先以挂起模式运行某个进程( A.exe),然后将完全不同的一个PE文件( B.exe)的PE映像映射到A.exe进程内存空间，并在A.exe进程的内存空间中运行。</p>
<p>修改PE映像后，进程名称仍为原来的A.exe,但实际映射在进程内存中的PE映像为B.exe,所以最终会产生与原来( A.exe)完全不同的行为动作。此时，A.exe为“外壳进程”，实际运行的B.exe为“内核进程”(参考下图)。</p>
<p><img src="3.png" alt=""></p>
<h1 id="示例程序：Fake-exe-Real-exe-DebugMe3-exe"><a href="#示例程序：Fake-exe-Real-exe-DebugMe3-exe" class="headerlink" title="示例程序：Fake.exe Real.exe DebugMe3.exe"></a>示例程序：Fake.exe Real.exe DebugMe3.exe</h1><p>首先运行fake.exe程序的画面如图<br><img src="4.png" alt=""><br>fake.exe是基于GUI的程序 用来在控制台输出简单的字符串 接下来运行real.exe程序的画面如图：</p>
<p><img src="5.png" alt=""><br>real.exe是基于GUI的程序，用来在图形窗口输出简单的字符串。从上面运行画面可以看到，fake.exe与real.exe程序拥有不同的用户环境。接下来，我们将运用PE映像切换技术，尝试以“外壳进程”形式运行fake.exe,以“内核进程”形式运行real.exe。打开控制台窗口,运行DebugMe3.exe程序，如下图所示(请务必输人正确的运行参数)。</p>
<p>在控制台窗口输入运行命令时，命令的第一个参数为充当“外壳进程”的可执行文件路径( fake.exe),第二个参数为充当“内核进程”的可执行文件路径( real.exe )。</p>
<p><img src="6.png" alt=""><br>然后查看fake.exe的应用进程 如下图所示：<br>从图中可以看到 运行的进程明明为fake.exe 但实际运行的却是real.exe进程 DebugMe3.exe进程删除了fake.exe的PE映像 将real.exe的PE映像映射到fake.exe的进程内存空间并运行。</p>
<p><img src="7.png" alt=""></p>
<h1 id="调试1"><a href="#调试1" class="headerlink" title="调试1"></a>调试1</h1><h2 id="Open-输入运行参数"><a href="#Open-输入运行参数" class="headerlink" title="Open-输入运行参数"></a>Open-输入运行参数</h2><p>首先在OD中的”打开“对话框选择DebugMe3.exe程序 输入运行参数 然后单击“打开”按钮</p>
<p><img src="8.png" alt=""><br><img src="9.png" alt=""></p>
<h2 id="main-函数"><a href="#main-函数" class="headerlink" title="main()函数"></a>main()函数</h2><p>main（）函数代码很长<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">00401000      55            push    ebp</span><br><span class="line">00401001      8BEC          mov     ebp, esp</span><br><span class="line">00401003  |.  83E4 F8       and     esp, 0xFFFFFFF8</span><br><span class="line">00401006  |.  83EC 5C       sub     esp, 0x5C</span><br><span class="line">00401009  |.  53            push    ebx</span><br><span class="line">0040100A  |.  56            push    esi</span><br><span class="line">0040100B  |.  57            push    edi</span><br><span class="line">0040100C  |.  6A 40         push    0x40</span><br><span class="line">0040100E  |.  8D4424 28     lea     eax, dword ptr ss:[esp+0x28]</span><br><span class="line">00401012  |.  6A 00         push    0x0</span><br><span class="line">00401014  |.  50            push    eax</span><br><span class="line">00401015  |.  C74424 2C 440&gt;mov     dword ptr ss:[esp+0x2C], 0x44</span><br><span class="line">0040101D  |.  E8 CE450000   call    DebugMe3.004055F0</span><br><span class="line">00401022  |.  33C0          xor     eax, eax</span><br><span class="line">00401024  |.  83C4 0C       add     esp, 0xC</span><br><span class="line">00401027  |.  837D 08 03    cmp     [arg.1], 0x3</span><br><span class="line">0040102B  |.  C74424 10 000&gt;mov     dword ptr ss:[esp+0x10], 0x0</span><br><span class="line">00401033  |.  894424 14     mov     dword ptr ss:[esp+0x14], eax</span><br><span class="line">00401037  |.  894424 18     mov     dword ptr ss:[esp+0x18], eax</span><br><span class="line">0040103B  |.  894424 1C     mov     dword ptr ss:[esp+0x1C], eax</span><br><span class="line">0040103F  |.  74 1C         je      short DebugMe3.0040105D</span><br><span class="line">00401041  |.  8B4D 0C       mov     ecx, [arg.2]</span><br><span class="line">00401044  |.  8B11          mov     edx, dword ptr ds:[ecx]</span><br><span class="line">00401046  |.  52            push    edx                              ;  DebugMe3.0040DA90</span><br><span class="line">00401047  |.  68 E0B14000   push    DebugMe3.0040B1E0                ;  ASCII &quot;USAGE : %s &lt;fake file path&gt; &lt;real file path&gt;\n&quot;</span><br><span class="line">0040104C  |.  E8 BC040000   call    DebugMe3.0040150D</span><br><span class="line">00401051  |.  83C4 08       add     esp, 0x8</span><br><span class="line">00401054  |.  33C0          xor     eax, eax</span><br><span class="line">00401056  |.  5F            pop     edi                              ;  DebugMe3.004017D8</span><br><span class="line">00401057  |.  5E            pop     esi                              ;  DebugMe3.004017D8</span><br><span class="line">00401058  |.  5B            pop     ebx                              ;  DebugMe3.004017D8</span><br><span class="line">00401059  |.  8BE5          mov     esp, ebp</span><br><span class="line">0040105B  |.  5D            pop     ebp                              ;  DebugMe3.004017D8</span><br><span class="line">0040105C  |.  C3            retn</span><br><span class="line">0040105D  |&gt;  8B75 0C       mov     esi, [arg.2]</span><br><span class="line">00401060  |.  8B46 08       mov     eax, dword ptr ds:[esi+0x8]</span><br><span class="line">00401063  |.  E8 E8000000   call    DebugMe3.00401150				 ;	SubFunc_1</span><br><span class="line">00401068  |.  8BF8          mov     edi, eax</span><br><span class="line">0040106A  |.  85FF          test    edi, edi</span><br><span class="line">0040106C  |.  0F84 D2000000 je      DebugMe3.00401144</span><br><span class="line">00401072  |.  8B56 04       mov     edx, dword ptr ds:[esi+0x4]</span><br><span class="line">00401075  |.  8D4424 10     lea     eax, dword ptr ss:[esp+0x10]</span><br><span class="line">00401079  |.  50            push    eax                              ; /pProcessInfo = 003A30C0</span><br><span class="line">0040107A  |.  8D4C24 24     lea     ecx, dword ptr ss:[esp+0x24]     ; |</span><br><span class="line">0040107E  |.  51            push    ecx                              ; |pStartupInfo = 00000001</span><br><span class="line">0040107F  |.  6A 00         push    0x0                              ; |CurrentDir = NULL</span><br><span class="line">00401081  |.  6A 00         push    0x0                              ; |pEnvironment = NULL</span><br><span class="line">00401083  |.  6A 04         push    0x4                              ; |CreationFlags = CREATE_SUSPENDED</span><br><span class="line">00401085  |.  6A 00         push    0x0                              ; |InheritHandles = FALSE</span><br><span class="line">00401087  |.  6A 00         push    0x0                              ; |pThreadSecurity = NULL</span><br><span class="line">00401089  |.  6A 00         push    0x0                              ; |pProcessSecurity = NULL</span><br><span class="line">0040108B  |.  52            push    edx                              ; |CommandLine = &quot;粙..&quot;</span><br><span class="line">0040108C  |.  6A 00         push    0x0                              ; |ModuleFileName = NULL</span><br><span class="line">0040108E  |.  FF15 0C904000 call    near dword ptr ds:[&lt;&amp;KERNEL32.Cr&gt;; \CreateProcessW</span><br><span class="line">00401094  |.  85C0          test    eax, eax</span><br><span class="line">00401096  |.  75 16         jnz     short DebugMe3.004010AE</span><br><span class="line">00401098  |.  FF15 24904000 call    near dword ptr ds:[&lt;&amp;KERNEL32.Ge&gt;; [GetLastError</span><br><span class="line">0040109E  |.  50            push    eax</span><br><span class="line">0040109F  |.  68 60B14000   push    DebugMe3.0040B160                ;  ASCII &quot;CreateProcess() failed! [%d]\n&quot;</span><br><span class="line">004010A4  |.  E8 64040000   call    DebugMe3.0040150D</span><br><span class="line">004010A9  |.  83C4 08       add     esp, 0x8</span><br><span class="line">004010AC  |.  EB 71         jmp     short DebugMe3.0040111F</span><br><span class="line">004010AE  |&gt;  8D7424 10     lea     esi, dword ptr ss:[esp+0x10]</span><br><span class="line">004010B2  |.  E8 19010000   call    DebugMe3.004011D0				 ;	SubFunc_2</span><br><span class="line">004010B7  |.  85C0          test    eax, eax</span><br><span class="line">004010B9  |.  75 0F         jnz     short DebugMe3.004010CA</span><br><span class="line">004010BB  |.  68 80B14000   push    DebugMe3.0040B180                ;  ASCII &quot;UnmapFakeProcImage() failed!!!\n&quot;</span><br><span class="line">004010C0  |.  E8 48040000   call    DebugMe3.0040150D</span><br><span class="line">004010C5  |.  83C4 04       add     esp, 0x4</span><br><span class="line">004010C8  |.  EB 55         jmp     short DebugMe3.0040111F</span><br><span class="line">004010CA  |&gt;  8D4424 10     lea     eax, dword ptr ss:[esp+0x10]</span><br><span class="line">004010CE  |.  50            push    eax                              ; /Arg1 = 003A30C0 ASCII &quot;@1:&quot;</span><br><span class="line">004010CF  |.  8BDF          mov     ebx, edi                         ; |</span><br><span class="line">004010D1  |.  E8 4A020000   call    DebugMe3.00401320                ; SubFunc_3</span><br><span class="line">004010D6  |.  83C4 04       add     esp, 0x4</span><br><span class="line">004010D9  |.  85C0          test    eax, eax</span><br><span class="line">004010DB  |.  75 0F         jnz     short DebugMe3.004010EC</span><br><span class="line">004010DD  |.  68 A0B14000   push    DebugMe3.0040B1A0                ;  ASCII &quot;MapRealProcImage() failed!!!\n&quot;</span><br><span class="line">004010E2  |.  E8 26040000   call    DebugMe3.0040150D</span><br><span class="line">004010E7  |.  83C4 04       add     esp, 0x4</span><br><span class="line">004010EA  |.  EB 33         jmp     short DebugMe3.0040111F</span><br><span class="line">004010EC  |&gt;  8B4C24 14     mov     ecx, dword ptr ss:[esp+0x14]</span><br><span class="line">004010F0  |.  51            push    ecx                              ; /hThread = 00000001</span><br><span class="line">004010F1  |.  FF15 38904000 call    near dword ptr ds:[&lt;&amp;KERNEL32.Re&gt;; \ResumeThread</span><br><span class="line">004010F7  |.  83F8 FF       cmp     eax, -0x1</span><br><span class="line">004010FA  |.  75 16         jnz     short DebugMe3.00401112</span><br><span class="line">004010FC  |.  FF15 24904000 call    near dword ptr ds:[&lt;&amp;KERNEL32.Ge&gt;; [GetLastError</span><br><span class="line">00401102  |.  50            push    eax</span><br><span class="line">00401103  |.  68 C0B14000   push    DebugMe3.0040B1C0                ;  ASCII &quot;ResumeThread() failed! [%d]\n&quot;</span><br><span class="line">00401108  |.  E8 00040000   call    DebugMe3.0040150D</span><br><span class="line">0040110D  |.  83C4 08       add     esp, 0x8</span><br><span class="line">00401110  |.  EB 0D         jmp     short DebugMe3.0040111F</span><br><span class="line">00401112  |&gt;  8B5424 10     mov     edx, dword ptr ss:[esp+0x10]</span><br><span class="line">00401116  |.  6A FF         push    -0x1                             ; /Timeout = INFINITE</span><br><span class="line">00401118  |.  52            push    edx                              ; |hObject = 0040DA90</span><br><span class="line">00401119  |.  FF15 10904000 call    near dword ptr ds:[&lt;&amp;KERNEL32.Wa&gt;; \WaitForSingleObject</span><br><span class="line">0040111F  |&gt;  57            push    edi</span><br><span class="line">00401120  |.  E8 A5040000   call    DebugMe3.004015CA</span><br><span class="line">00401125  |.  8B4424 14     mov     eax, dword ptr ss:[esp+0x14]</span><br><span class="line">00401129  |.  8B35 30904000 mov     esi, dword ptr ds:[&lt;&amp;KERNEL32.Cl&gt;;  kernel32.CloseHandle</span><br><span class="line">0040112F  |.  83C4 04       add     esp, 0x4</span><br><span class="line">00401132  |.  85C0          test    eax, eax</span><br><span class="line">00401134  |.  74 03         je      short DebugMe3.00401139</span><br><span class="line">00401136  |.  50            push    eax                              ; /hObject = 003A30C0</span><br><span class="line">00401137  |.  FFD6          call    near esi                         ; \CloseHandle</span><br><span class="line">00401139  |&gt;  8B4424 14     mov     eax, dword ptr ss:[esp+0x14]</span><br><span class="line">0040113D  |.  85C0          test    eax, eax</span><br><span class="line">0040113F  |.  74 03         je      short DebugMe3.00401144</span><br><span class="line">00401141  |.  50            push    eax</span><br><span class="line">00401142  |.  FFD6          call    near esi</span><br><span class="line">00401144  |&gt;  5F            pop     edi                              ;  DebugMe3.004017D8</span><br><span class="line">00401145  |.  5E            pop     esi                              ;  DebugMe3.004017D8</span><br><span class="line">00401146  |.  33C0          xor     eax, eax</span><br><span class="line">00401148  |.  5B            pop     ebx                              ;  DebugMe3.004017D8</span><br><span class="line">00401149  |.  8BE5          mov     esp, ebp</span><br><span class="line">0040114B  |.  5D            pop     ebp                              ;  DebugMe3.004017D8</span><br><span class="line">0040114C  \.  C3            retn</span><br></pre></td></tr></table></figure></p>
<p><strong>代码流程图</strong><br>根据上述代码画出main（）函数的代码流程图：<br><img src="10.png" alt=""><br>由于CreateProcess（）与ResumeThread（）API的行为动作非常明确 所以下面调试main（）调用的3个子函数(SubFunc_1~3)为主</p>
<h2 id="SubFunc-1（）"><a href="#SubFunc-1（）" class="headerlink" title="SubFunc_1（）"></a>SubFunc_1（）</h2><p>我们将代码运行至SubFunc_1（）函数处 然后步入函数 代码如图：<br><img src="11.png" alt=""><br>SunFunc_ 1()函数内部仅调用了Win32 API,没有调用其他子函数。SunFunc_ 1()函数用来将real.exe文件整个读人内存，此后，内存中存储的就是real.exe文件的内容。为了方便，我们将该内存地址称为MEM_ FILE REAL EXE。SunFunc _1()函数执行完成后，执行程序将其返回main()函数。</p>
<h2 id="CreateProcess-“fake-exe”-CREATE-SUSPENDED"><a href="#CreateProcess-“fake-exe”-CREATE-SUSPENDED" class="headerlink" title="CreateProcess(“fake.exe”,CREATE_SUSPENDED)"></a>CreateProcess(“fake.exe”,CREATE_SUSPENDED)</h2><p>程序执行至main（）函数的401079地址处 出现调用CreateProcess（）API代码<br><img src="12.png" alt=""><br>上面代码用来创建fake.exe的进程 其参数CREATE_SUSPENDED用来指定该进程处于挂起状态 进程被挂起时处于暂停状态 此时可以自由操作对应的内存</p>
<h2 id="SubFunc-2（）"><a href="#SubFunc-2（）" class="headerlink" title="SubFunc_2（）"></a>SubFunc_2（）</h2><p>下面进入SubFunc_2（）的代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">004011D0  /$  55            push    ebp</span><br><span class="line">004011D1  |.  8BEC          mov     ebp, esp</span><br><span class="line">004011D3  |.  81EC D4020000 sub     esp, 0x2D4</span><br><span class="line">004011D9  |.  A1 3CC04000   mov     eax, dword ptr ds:[0x40C03C]</span><br><span class="line">004011DE  |.  33C5          xor     eax, ebp</span><br><span class="line">004011E0  |.  8945 FC       mov     [local.1], eax</span><br><span class="line">004011E3  |.  68 C8020000   push    0x2C8</span><br><span class="line">004011E8  |.  8D85 34FDFFFF lea     eax, [local.179]</span><br><span class="line">004011EE  |.  6A 00         push    0x0</span><br><span class="line">004011F0  |.  50            push    eax</span><br><span class="line">004011F1  |.  C785 2CFDFFFF&gt;mov     [local.181], 0x0</span><br><span class="line">004011FB  |.  E8 F0430000   call    DebugMe3.004055F0</span><br><span class="line">00401200  |.  8B56 04       mov     edx, dword ptr ds:[esi+0x4]</span><br><span class="line">00401203  |.  83C4 0C       add     esp, 0xC</span><br><span class="line">00401206  |.  8D8D 30FDFFFF lea     ecx, [local.180]</span><br><span class="line">0040120C  |.  51            push    ecx                              ; /pContext = kernel32.7C818A12</span><br><span class="line">0040120D  |.  52            push    edx                              ; |hThread = 7C92E514</span><br><span class="line">0040120E  |.  C785 30FDFFFF&gt;mov     [local.180], 0x10007             ; |</span><br><span class="line">00401218  |.  FF15 00904000 call    near dword ptr ds:[&lt;&amp;KERNEL32.Ge&gt;; \GetThreadContext</span><br><span class="line">0040121E  |.  85C0          test    eax, eax</span><br><span class="line">00401220  |.  75 24         jnz     short DebugMe3.00401246</span><br><span class="line">00401222  |.  FF15 24904000 call    near dword ptr ds:[&lt;&amp;KERNEL32.Ge&gt;; [GetLastError</span><br><span class="line">00401228  |.  50            push    eax</span><br><span class="line">00401229  |.  68 10B24000   push    DebugMe3.0040B210                ;  ASCII &quot;GetThreadContext() failed! [%d]\n&quot;</span><br><span class="line">0040122E  |.  E8 DA020000   call    DebugMe3.0040150D</span><br><span class="line">00401233  |.  83C4 08       add     esp, 0x8</span><br><span class="line">00401236  |.  33C0          xor     eax, eax</span><br><span class="line">00401238  |.  8B4D FC       mov     ecx, [local.1]                   ;  DebugMe3.00403CC5</span><br><span class="line">0040123B  |.  33CD          xor     ecx, ebp</span><br><span class="line">0040123D  |.  E8 BC020000   call    DebugMe3.004014FE</span><br><span class="line">00401242  |.  8BE5          mov     esp, ebp</span><br><span class="line">00401244  |.  5D            pop     ebp                              ;  DebugMe3.004010B7</span><br><span class="line">00401245  |.  C3            retn</span><br><span class="line">00401246  |&gt;  8B8D D4FDFFFF mov     ecx, [local.139]</span><br><span class="line">0040124C  |.  8B16          mov     edx, dword ptr ds:[esi]</span><br><span class="line">0040124E  |.  6A 00         push    0x0                              ; /pBytesRead = NULL</span><br><span class="line">00401250  |.  6A 04         push    0x4                              ; |BytesToRead = 0x4</span><br><span class="line">00401252  |.  8D85 2CFDFFFF lea     eax, [local.181]                 ; |</span><br><span class="line">00401258  |.  50            push    eax                              ; |Buffer = 00000001</span><br><span class="line">00401259  |.  83C1 08       add     ecx, 0x8                         ; |</span><br><span class="line">0040125C  |.  51            push    ecx                              ; |pBaseAddress = 0x7C818A12</span><br><span class="line">0040125D  |.  52            push    edx                              ; |hProcess = 7C92E514</span><br><span class="line">0040125E  |.  FF15 18904000 call    near dword ptr ds:[&lt;&amp;KERNEL32.Re&gt;; \ReadProcessMemory</span><br><span class="line">00401264  |.  85C0          test    eax, eax</span><br><span class="line">00401266  |.  75 24         jnz     short DebugMe3.0040128C</span><br><span class="line">00401268  |.  FF15 24904000 call    near dword ptr ds:[&lt;&amp;KERNEL32.Ge&gt;; [GetLastError</span><br><span class="line">0040126E  |.  50            push    eax</span><br><span class="line">0040126F  |.  68 34B24000   push    DebugMe3.0040B234                ;  ASCII &quot;ReadProcessMemory() failed! [%d]\n&quot;</span><br><span class="line">00401274  |.  E8 94020000   call    DebugMe3.0040150D</span><br><span class="line">00401279  |.  83C4 08       add     esp, 0x8</span><br><span class="line">0040127C  |.  33C0          xor     eax, eax</span><br><span class="line">0040127E  |.  8B4D FC       mov     ecx, [local.1]                   ;  DebugMe3.00403CC5</span><br><span class="line">00401281  |.  33CD          xor     ecx, ebp</span><br><span class="line">00401283  |.  E8 76020000   call    DebugMe3.004014FE</span><br><span class="line">00401288  |.  8BE5          mov     esp, ebp</span><br><span class="line">0040128A  |.  5D            pop     ebp                              ;  DebugMe3.004010B7</span><br><span class="line">0040128B  |.  C3            retn</span><br><span class="line">0040128C  |&gt;  8B47 3C       mov     eax, dword ptr ds:[edi+0x3C]</span><br><span class="line">0040128F  |.  8B4C38 34     mov     ecx, dword ptr ds:[eax+edi+0x34]</span><br><span class="line">00401293  |.  8D4438 34     lea     eax, dword ptr ds:[eax+edi+0x34]</span><br><span class="line">00401297  |.  3B8D 2CFDFFFF cmp     ecx, [local.181]</span><br><span class="line">0040129D  |.  75 4B         jnz     short DebugMe3.004012EA</span><br><span class="line">0040129F  |.  68 58B24000   push    DebugMe3.0040B258                ; /ProcNameOrOrdinal = &quot;ZwUnmapViewOfSection&quot;</span><br><span class="line">004012A4  |.  68 70B24000   push    DebugMe3.0040B270                ; |/pModule = &quot;ntdll.dll&quot;</span><br><span class="line">004012A9  |.  FF15 14904000 call    near dword ptr ds:[&lt;&amp;KERNEL32.Ge&gt;; |\GetModuleHandleW</span><br><span class="line">004012AF  |.  50            push    eax                              ; |hModule = 00000001</span><br><span class="line">004012B0  |.  FF15 28904000 call    near dword ptr ds:[&lt;&amp;KERNEL32.Ge&gt;; \GetProcAddress</span><br><span class="line">004012B6  |.  8B95 2CFDFFFF mov     edx, [local.181]</span><br><span class="line">004012BC  |.  8B0E          mov     ecx, dword ptr ds:[esi]</span><br><span class="line">004012BE  |.  52            push    edx                              ;  ntdll.KiFastSystemCallRet</span><br><span class="line">004012BF  |.  51            push    ecx                              ;  kernel32.7C818A12</span><br><span class="line">004012C0  |.  FFD0          call    near eax</span><br><span class="line">004012C2  |.  85C0          test    eax, eax</span><br><span class="line">004012C4  |.  74 3C         je      short DebugMe3.00401302</span><br><span class="line">004012C6  |.  FF15 24904000 call    near dword ptr ds:[&lt;&amp;KERNEL32.Ge&gt;; [GetLastError</span><br><span class="line">004012CC  |.  50            push    eax</span><br><span class="line">004012CD  |.  68 84B24000   push    DebugMe3.0040B284                ;  ASCII &quot;ZwUnmapViewOfSection() failed!!! [%d]\n&quot;</span><br><span class="line">004012D2  |.  E8 36020000   call    DebugMe3.0040150D</span><br><span class="line">004012D7  |.  83C4 08       add     esp, 0x8</span><br><span class="line">004012DA  |.  33C0          xor     eax, eax</span><br><span class="line">004012DC  |.  8B4D FC       mov     ecx, [local.1]                   ;  DebugMe3.00403CC5</span><br><span class="line">004012DF  |.  33CD          xor     ecx, ebp</span><br><span class="line">004012E1  |.  E8 18020000   call    DebugMe3.004014FE</span><br><span class="line">004012E6  |.  8BE5          mov     esp, ebp</span><br><span class="line">004012E8  |.  5D            pop     ebp                              ;  DebugMe3.004010B7</span><br><span class="line">004012E9  |.  C3            retn</span><br><span class="line">004012EA  |&gt;  8B95 D4FDFFFF mov     edx, [local.139]</span><br><span class="line">004012F0  |.  6A 00         push    0x0                              ; /pBytesWritten = NULL</span><br><span class="line">004012F2  |.  6A 04         push    0x4                              ; |BytesToWrite = 0x4</span><br><span class="line">004012F4  |.  50            push    eax                              ; |Buffer = 00000001</span><br><span class="line">004012F5  |.  8B06          mov     eax, dword ptr ds:[esi]          ; |</span><br><span class="line">004012F7  |.  83C2 08       add     edx, 0x8                         ; |</span><br><span class="line">004012FA  |.  52            push    edx                              ; |Address = 0x7C92E514</span><br><span class="line">004012FB  |.  50            push    eax                              ; |hProcess = 00000001</span><br><span class="line">004012FC  |.  FF15 34904000 call    near dword ptr ds:[&lt;&amp;KERNEL32.Wr&gt;; \WriteProcessMemory</span><br><span class="line">00401302  |&gt;  8B4D FC       mov     ecx, [local.1]                   ;  DebugMe3.00403CC5</span><br><span class="line">00401305  |.  33CD          xor     ecx, ebp</span><br><span class="line">00401307  |.  B8 01000000   mov     eax, 0x1</span><br><span class="line">0040130C  |.  E8 ED010000   call    DebugMe3.004014FE</span><br><span class="line">00401311  |.  8BE5          mov     esp, ebp</span><br><span class="line">00401313  |.  5D            pop     ebp                              ;  DebugMe3.004010B7</span><br><span class="line">00401314  \.  C3            retn</span><br></pre></td></tr></table></figure></p>
<p>SubFunc_2（）函数内部调用了PE映像切换技术</p>
<h3 id="获取fake-exe的实际映像地址"><a href="#获取fake-exe的实际映像地址" class="headerlink" title="获取fake.exe的实际映像地址"></a>获取fake.exe的实际映像地址</h3><p>在401218地址处调用GetThreadContext()API 获取fake.exe进程的主线程上下文</p>
<p><img src="13.png" alt=""><br>获取fake.exe进程的主线程上下文后 通过它来获取进程的PEB 然后再由PEB.ImageBase得到进程的实际映射地址（进程的实际映射地址存储在PEB.ImageBase成员） 在40125E地址处调用ReadProcessMemory（）API来获取fake.exe进程的映射地址</p>
<p><img src="14.png" alt=""><br>当前fake.exe进程是以挂起模式创建的 处于暂停状态<br><img src="15.png" alt=""><br>进程被创建出来 PE装载器就会对PEB结构体的地址设置给EBX寄存器 所以 要获取EBX寄存器的值必须先获取主线程的上下文 如下图：</p>
<p><img src="16.png" alt=""></p>
<h3 id="获取real-exe文件的ImageBase"><a href="#获取real-exe文件的ImageBase" class="headerlink" title="获取real.exe文件的ImageBase"></a>获取real.exe文件的ImageBase</h3><p>40128c 40128f地址处的指令用来读取real.exe文件的PE文件头信息 获取ImageBase</p>
<p><img src="17.png" alt=""><br>EDI寄存器的值为MEM_ FILE_ REAL EXE地址(该地址是在SubFunc_ 10)中分配得到的内存起始地址，real.exe 文件的内容被原封不动地保存其中)。也就是说，EDI指向real.exe文件的PE文件头。所以EDI+3C指的就是IMAGE_ DOS_ HEADER结构体的e_ lfanew成员( IDH.e_ lfanew)， 上述指令用来将它的值保存到EAX。</p>
<p><img src="18.png" alt=""><br>上面的指令中, EAX+EDI=IDH.e_ lfanew+Start of PE是IMAGE NT HEADER结构体的起始地址，EAX+EDI+34指的是IMAGE_ OPTION HEADER.ImageBase成员。执行上述指令后，real.exe文件的ImageBase值将被存人ECX寄存器</p>
<h3 id="比较：ImageBase-of-fake-exe-amp-ImageBase-of-real-exe"><a href="#比较：ImageBase-of-fake-exe-amp-ImageBase-of-real-exe" class="headerlink" title="比较：ImageBase of fake.exe&amp;ImageBase of real.exe"></a>比较：ImageBase of fake.exe&amp;ImageBase of real.exe</h3><p>比较 fake.exe进程的实际映射地址与real.exe的ImageBase<br><img src="19.png" alt=""><br>比较2个ImageBase的值 并根据结果确定要执行的分支 若相同 则跳转到40129f处 否则跳转到4012EA处</p>
<p><strong>两值相同时</strong><br><img src="20.png" alt=""><br>如上图所示，此种情形下，fake .exe的PE映像已经映射到00000地址处，地址00000也是real.exe的PE映像要映射的地址。若将real.exe强 行映射到该地址处，就会发生冲突，所以必须先卸载( Unmapping ) fake.exe的PE映像的映射。由于fake. exe进程处于挂起状态，所以卸载PE映像时进程中也不会发生错误。</p>
<p><img src="21.png" alt=""><br>卸载进程的PE映像时 调用的是ntdll！ZwUnmapViewOfSection()API 其函数原型如下</p>
<p><img src="22.png" alt=""><br><strong>两值不同时</strong><br><img src="23.png" alt=""><br>如上图所示，2个ImageBase值不同时，不必非得卸载fake.exe的PE映像，可以先在fake.exe进程的虚拟内存空间中为real.exe的PE映像分配所需空间，然后将real.exe映射进去就可以了。接下来还要告知PE装载器，fake.exe进程的PE映像是40000地址处的real.exe,而不是000000地址处的fake.exe。简单修改PEB的ImageBase成员即可。</p>
<p><img src="24.png" alt=""><br>以上代码调用了4012FC地址处的WriteProcessMemory()API 将fake.exe进程的PEB.ImageBase值修改为real.exe文件的ImageBase值。</p>
<p>经过以上的操作 fake.exe进程的PE映像就被卸载（PEB.ImageBase）了 即fake.exe进程的PE映像被删除了。</p>
<h2 id="SubFunc-3（）"><a href="#SubFunc-3（）" class="headerlink" title="SubFunc_3（）"></a>SubFunc_3（）</h2><p>接下来要把real.exe文件映射到fake.exe进程 main（）函数的4010D1地址处是调用Subfunc_3()函数的指令 步入该函数</p>
<p><img src="25.png" alt=""></p>
<h3 id="为real-exe的PE映像分配内存"><a href="#为real-exe的PE映像分配内存" class="headerlink" title="为real.exe的PE映像分配内存"></a>为real.exe的PE映像分配内存</h3><p>这里我们在401383地址处遇到调用VirtualAllocEx()函数指令</p>
<p><img src="26.png" alt=""><br>此时查看存储在栈中的函数参数。函数的第二个参数为欲分配的内存起始地址,其值为real.exe的ImageBase ( 400000 );函数的第三个参数Arg3为欲分配的内存大小，其值为real.exe的SizeOflmage ( A000)。总之，调用VirtualAllocEx() API后，即在fake.exe进 程中为real.exe的PE映像分配了内存空间</p>
<h3 id="映射PE文件头"><a href="#映射PE文件头" class="headerlink" title="映射PE文件头"></a>映射PE文件头</h3><p>为real.exe的PE映像分配好内存后 接下来就要将real.exe映射到fake.exe进程</p>
<p>如下图所示 在401405地址处调用WriteProcessMemory()API 将real.exe的PE文件头写入刚刚分配的内存区域（3A5218地址既是real.exe文件（MEN_FILE_REAL_EXE）由SubFunc_1()函数读入）</p>
<p><img src="27.png" alt=""></p>
<h3 id="映射PE节区"><a href="#映射PE节区" class="headerlink" title="映射PE节区"></a>映射PE节区</h3><p>接下来映射PE节区（PE Section）了<br><img src="27.png" alt=""><br>启动循环，根据节区数量反复调用WriteProcessMemory( API (上图为部分循环代码),映射PE节区。该过程需要的信息(地址、大小等)是读取PE文件头的IMAGE SECTION HEADER获取的(请各位亲自调试并确认)。上述循环结束后,real.exe文件即被完全映射至fake.exe进程的40000地址处( real.exe的ImageBase )。但是此时real.exe代码还无法正常运行,需要修改进程的EP。</p>
<h3 id="修改EP"><a href="#修改EP" class="headerlink" title="修改EP"></a>修改EP</h3><p>当前fake.exe进程处于挂起状态 将其恢复运行后 进程的主线程会运行到何处？我们首先得获取主线程的CONTEXT结构体 然后查看其Eip成员值</p>
<p><img src="28.png" alt=""><br>如上图所示 在401442地址处调用GetThreadContext()API 获取fake.exe进程的主线程的CONTEXT结构体</p>
<p>可将上述代码的执行过程整理为:处于挂起状态的fake. exe进程恢复运行后，首先会调用ntdll.RtlUserThreadStart() API( CONTEXT.Eip ),跳转至EP地址处( CONTEXT.Eax )。由于前面已经将fake.exe进程的PE映像替换为real.exe,所以需要将CONTEXT.Eax修改为realexe的EP地址( 401060 )。</p>
<p>观察下图中的代码，位于4014A2~4014A5地址处的MOV、ADD指令用来将401 060地址(real.exe的EP地址)设置到EDX寄存器。而4014B3地址处的MOV指令又将该地址值传送到[EBP-220] ( CONTEXT.Eax )。然后调用SetThreadContext() API,将更改应用到fake.exe进程。这样就将fake.exe进程的PE映像由原来的fake.exe更换为real.exe。</p>
<p><img src="29.png" alt=""></p>
<h2 id="ResumeThread"><a href="#ResumeThread" class="headerlink" title="ResumeThread()"></a>ResumeThread()</h2><p>最后 调用ResumeThread() 恢复运行fake.exe进程<br><img src="30.png" alt=""><br>如图 让拥有real.exe的PE映像核心的fake.exe进程重新运行起来<br><img src="31.png" alt=""></p>
<h1 id="调试2"><a href="#调试2" class="headerlink" title="调试2"></a>调试2</h1><p>下面进行fake.exe进程的调试</p>
<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><p>将real.exe文件映射到fake.exe进程前，向real.exe的EP代码设置无限循环。向fake. exe进程映射完real.exe文件并恢复运行时，它的EP代码会被执行,导致程序运行陷人已设置好的无限循环。此时，借助调试器的附加功能将其附加到调试器即可调试。</p>
<h2 id="向EP设置无限循环"><a href="#向EP设置无限循环" class="headerlink" title="向EP设置无限循环"></a>向EP设置无限循环</h2><p>如图所示，借助Stud PE工具查看,获知real.exe文件的EP偏移为1060。SubFunc_ 10函数负责将real.exe文件读人内存，所以只要在EP处设置无限循环代码就可以了</p>
<p><img src="32.png" alt=""><br>先在调试器中打开DebugMe3.exe ，然后调试运行到4011B5地址处，如图所示 。</p>
<p><img src="33.png" alt=""><br>缓冲区的起始地址为5c27f0 raal.exe的偏移量为1060 将二者相加得到real.exe的EP代码的实际地址5c3850</p>
<p><img src="34.png" alt=""><br>然后将EP代码的前两个字节558B改为EBFE<br><img src="35.png" alt=""><br>然后F9运行程序到最后 fake.exe进程就会进入无限循环 再打开新的调试器 用Attach命令附加进程对话框</p>
<p><img src="36.png" alt=""><br>然后代码就停到了EP代码处的无限循环<br><img src="37.png" alt=""><br>将其恢复原来指令的代码（558B）<br><img src="38.png" alt=""><br>接下来就可以对fake.exe进程进行调试了~</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>学习了PE映像切换技术，借助这种神奇的技术可以将B进程作为“内核”加载到充当“外壳”的A进程，并在其中正常运行。该技术不但作为反调试技术应用于PE保护器，也常常被恶意代码用来将自己伪装成正常程序。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/07/22/调试练习2：自我创建/" rel="next" title="调试练习2：自我创建">
                <i class="fa fa-chevron-left"></i> 调试练习2：自我创建
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/07/24/调试练习4：Debug-Blocker/" rel="prev" title="调试练习4：Debug Blocker">
                调试练习4：Debug Blocker <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">loser</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#PE映像"><span class="nav-number">1.</span> <span class="nav-text">PE映像</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PE映像切换"><span class="nav-number">2.</span> <span class="nav-text">PE映像切换</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#示例程序：Fake-exe-Real-exe-DebugMe3-exe"><span class="nav-number">3.</span> <span class="nav-text">示例程序：Fake.exe Real.exe DebugMe3.exe</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#调试1"><span class="nav-number">4.</span> <span class="nav-text">调试1</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Open-输入运行参数"><span class="nav-number">4.1.</span> <span class="nav-text">Open-输入运行参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#main-函数"><span class="nav-number">4.2.</span> <span class="nav-text">main()函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SubFunc-1（）"><span class="nav-number">4.3.</span> <span class="nav-text">SubFunc_1（）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CreateProcess-“fake-exe”-CREATE-SUSPENDED"><span class="nav-number">4.4.</span> <span class="nav-text">CreateProcess(“fake.exe”,CREATE_SUSPENDED)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SubFunc-2（）"><span class="nav-number">4.5.</span> <span class="nav-text">SubFunc_2（）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#获取fake-exe的实际映像地址"><span class="nav-number">4.5.1.</span> <span class="nav-text">获取fake.exe的实际映像地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取real-exe文件的ImageBase"><span class="nav-number">4.5.2.</span> <span class="nav-text">获取real.exe文件的ImageBase</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#比较：ImageBase-of-fake-exe-amp-ImageBase-of-real-exe"><span class="nav-number">4.5.3.</span> <span class="nav-text">比较：ImageBase of fake.exe&amp;ImageBase of real.exe</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SubFunc-3（）"><span class="nav-number">4.6.</span> <span class="nav-text">SubFunc_3（）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#为real-exe的PE映像分配内存"><span class="nav-number">4.6.1.</span> <span class="nav-text">为real.exe的PE映像分配内存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#映射PE文件头"><span class="nav-number">4.6.2.</span> <span class="nav-text">映射PE文件头</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#映射PE节区"><span class="nav-number">4.6.3.</span> <span class="nav-text">映射PE节区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改EP"><span class="nav-number">4.6.4.</span> <span class="nav-text">修改EP</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ResumeThread"><span class="nav-number">4.7.</span> <span class="nav-text">ResumeThread()</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#调试2"><span class="nav-number">5.</span> <span class="nav-text">调试2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#方法"><span class="nav-number">5.1.</span> <span class="nav-text">方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#向EP设置无限循环"><span class="nav-number">5.2.</span> <span class="nav-text">向EP设置无限循环</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">6.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">loser</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
