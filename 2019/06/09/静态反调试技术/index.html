<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="chinese">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="PEBPEB中与反调试技术密切相关的成员有如下几个">
<meta property="og:type" content="article">
<meta property="og:title" content="静态反调试技术">
<meta property="og:url" content="http://yoursite.com/2019/06/09/静态反调试技术/index.html">
<meta property="og:site_name" content="loser的博客">
<meta property="og:description" content="PEBPEB中与反调试技术密切相关的成员有如下几个">
<meta property="og:locale" content="chinese">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/1.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/2.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/3.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/4.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/5.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/6.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/7.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/8.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/9.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/10.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/11.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/12.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/13.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/14.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/15.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/16.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/17.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/19.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/18.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/20.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/21.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/22.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/23.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/24.png">
<meta property="og:image" content="http://yoursite.com/2019/06/09/静态反调试技术/25.png">
<meta property="og:updated_time" content="2019-07-19T12:13:18.276Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="静态反调试技术">
<meta name="twitter:description" content="PEBPEB中与反调试技术密切相关的成员有如下几个">
<meta name="twitter:image" content="http://yoursite.com/2019/06/09/静态反调试技术/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/06/09/静态反调试技术/">





  <title>静态反调试技术 | loser的博客</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="chinese">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">loser的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/09/静态反调试技术/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="loser">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="loser的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">静态反调试技术</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-09T21:10:44+08:00">
                2019-06-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="PEB"><a href="#PEB" class="headerlink" title="PEB"></a>PEB</h1><p>PEB中与反调试技术密切相关的成员有如下几个</p>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">+0x002 BeingDebugged; UChar</span><br><span class="line">+0x00c Ldr          ; Ptr32 _PEB_LDR_DATA</span><br><span class="line">+0X018 ProcessHeap  ; Ptr32 Void</span><br><span class="line">+0x068 NtGlobalFlag ; Uint4B</span><br></pre></td></tr></table></figure>
<p>BeingDebugged成员是一个标志，用来表示进程是否处于被调试状态</p>
<p>Ldr, ProcessHeap, NtGloabFlag成员与被调试进程的堆内存特性相关<br><strong>获取PEB结构体的地址</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 第一种方法</span><br><span class="line">MOV EAX, DWORD PTR FS:[0x30]</span><br><span class="line"># 第二种方法</span><br><span class="line">MOV EAX, DWORD PTR FS:[0x18]</span><br><span class="line">MOV EAX, DWORD PTR DS:[EAX+0x30]</span><br></pre></td></tr></table></figure></p>
<h2 id="BeingDebugged-0x2"><a href="#BeingDebugged-0x2" class="headerlink" title="BeingDebugged(+0x2)"></a>BeingDebugged(+0x2)</h2><p>通过IsDebuggerPresent() API可以获取PEB.BeingDebugged的值，若为1则表示进程处于被调试状态</p>
<p><strong>IsDebuggerPresent()</strong><br>IsDebuggerPresent()API获取PEB.BeingDebugged的值来判断进程是否处于被调试状态 </p>
<p><img src="1.png" alt=""><br>破解方法：只要借助OD，将PEB.BeingDebugged的值修改为0即可</p>
<h2 id="Ldr-0xC"><a href="#Ldr-0xC" class="headerlink" title="Ldr(+0xC)"></a>Ldr(+0xC)</h2><p>调试进程时其堆内存就会出现一些特殊标识，表示它正处于被调试状态</p>
<p>其中最醒目的是，未使用的堆内存区域全部填充着0xFEEEFEEE，这证明正在调试进程</p>
<p>PEB.Ldr成员是一个指向_PEB_LDR_DATA结构体的指针，而_PEB_LDR_DATA结构体恰好是在堆内存区域中创建的，所以扫描该区域即可轻松查找是否存在0xFEEEFEEE区域</p>
<p><img src="2.png" alt=""><br>进入PEB.Ldr地址（251ea0）向下拖动滚动条<br><img src="3.png" alt=""><br>破解方法：只要将填充着0xFEEEFEEE的区域全部覆写为NULL即可</p>
<p>注意：该方法只适用于WindowsXP，而在Windows Vista以后的系统中则无法使用。另外，利用附加功能将运行中的进程附加到调试器时，堆内存中并不出现上述标识。</p>
<h2 id="ProcessHeap-0x18"><a href="#ProcessHeap-0x18" class="headerlink" title="ProcessHeap(+0x18)"></a>ProcessHeap(+0x18)</h2><p>PEB.ProcessHeap成员是指向HEAP结构体的指针</p>
<p>GetProcessHeap() API可以获取PEB.ProcessHeap结构体的地址</p>
<p><img src="4.png" alt=""><br>HEAP结构体中Flags(+0xC)和ForceFlags(+0x10)和反调试相关，进程正常运行时，Heap.Flags的值为0x2，Heap.ForceFlags的值为0x0，进程处于调试状态时这些值会改变。</p>
<p><img src="5.png" alt=""><br>破解方法：修改HEAP.Flags =2, HEAP.ForceFlags=0</p>
<p>注意：该方法只适用于WindowsXP，而在Windows Vista以后的系统中则无法使用。另外，利用附加功能将运行中的进程附加到调试器时，也不会有上述特征</p>
<h2 id="NtGlobalFlag-0x68"><a href="#NtGlobalFlag-0x68" class="headerlink" title="NtGlobalFlag(0x68)"></a>NtGlobalFlag(0x68)</h2><p>调试进程时，PEB.NtGlobalFlag会被设置为0x70 检测该成员的值就可以判断进程是否处于调试状态</p>
<p><img src="6.png" alt=""><br>注意：利用附加功能将运行中的进程附加到调试器时，不会有上述特征。</p>
<h2 id="练习：StaAD-PEB-exe（在WIN-XP下测试）"><a href="#练习：StaAD-PEB-exe（在WIN-XP下测试）" class="headerlink" title="练习：StaAD_PEB.exe（在WIN XP下测试）"></a>练习：StaAD_PEB.exe（在WIN XP下测试）</h2><p>下面调试StaAD_PEB.exe来学习基于PEB的反调试技术 以及相应的破解之法 在OD中按下F9运行程序  所有项目都显示处于调试之中</p>
<p><img src="7.png" alt=""></p>
<h2 id="破解之法"><a href="#破解之法" class="headerlink" title="破解之法"></a>破解之法</h2><p><strong>PEB.BeingDebugged</strong><br>跟踪代码 401036地址处遇到调用IsDebuggerPresent（）API代码 如图所示 F7进入代码 只要将EB.BeingDebugged值修改为0就可以破解</p>
<p><img src="8.png" alt=""><br><img src="9.png" alt=""><br><strong>PEB.Ldr</strong><br>继续调试会遇到PEB.Ldr反调试代码<br><img src="10.png" alt=""><br>40107b处的CALL EAX指令用来调用ntdll.NtCurrentTeb（）API 40107d地址处的MOV指令将PEB保存到EBX寄存器 地址401090~40109e间的指令用来将局部变量（[EBP-20]~[EBP-2C]）初始化为EEFEEEFE值 而4010A1地址处的MOV指令用来将PEB.Ldr地址储存到ESI寄存器 继续跟踪到4010C7处：</p>
<p><img src="11.png" alt=""><br>EDI寄存器中储存着PEB.Ldr地址读取4个字节值 我们看到ECX中的值为EEFEEEFE 我们转到EDX的数据窗口 并将EEFEEEFE区域用NULL覆盖 F2在4010FB地址处设置断点 F9跳出循环</p>
<p><img src="12.png" alt=""><br><strong>PEB.ProcessHeap</strong><br>继续调试 看到代码：<br><img src="13.png" alt=""><br>以上代码检测PEB.ProcessHeap.Flags和PEB.ProcessHeap.ForceFlags的值来反调试 将他们分别修改为2和0破解反调试</p>
<p><img src="14.png" alt=""><br><strong>PEB.NtGlobalFlag</strong><br>继续运行 遇到基于PEB.NtGlobalFlag的反调试代码<br><img src="15.png" alt=""><br>将401168处的[EBX+68]即为PEB.NtGlobalFlag 将其值修改为0即可</p>
<p>运行完的窗口<br><img src="16.png" alt=""></p>
<h1 id="NtQueryInformationProcess-API"><a href="#NtQueryInformationProcess-API" class="headerlink" title="NtQueryInformationProcess API"></a>NtQueryInformationProcess API</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS WINAPI NtQueryInformationProcess(</span><br><span class="line">  _In_      HANDLE           ProcessHandle,</span><br><span class="line">  _In_      PROCESSINFOCLASS ProcessInformationClass,</span><br><span class="line">  _Out_     PVOID            ProcessInformation,</span><br><span class="line">  _In_      ULONG            ProcessInformationLength,</span><br><span class="line">  _Out_opt_ PULONG           ReturnLength</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>为该函数第二个参数ProcessInformationClass设定特定的值，函数执行结果会保存在第三个参数ProcessInformation中</p>
<p>第二个参数为枚举类型，其中与反调试相关的参数有<strong>ProcessDebugPort（0x07）,ProcessDebugObject-Handle(0x1E),ProcessDebugFlags(0x1F)</strong></p>
<h2 id="ProcessDebugPort（0x07）"><a href="#ProcessDebugPort（0x07）" class="headerlink" title="ProcessDebugPort（0x07）"></a>ProcessDebugPort（0x07）</h2><p>非调试状态下debugport == 0<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// ProcessDebugPort (0x7)</span><br><span class="line">    DWORD dwDebugPort = 0;</span><br><span class="line">    pNtQueryInformationProcess(GetCurrentProcess(),</span><br><span class="line">                               ProcessDebugPort,</span><br><span class="line">                               &amp;dwDebugPort,</span><br><span class="line">                               sizeof(dwDebugPort),</span><br><span class="line">                               NULL);</span><br><span class="line">    printf(&quot;NtQueryInformationProcess(ProcessDebugPort) = 0x%X\n&quot;, dwDebugPort);</span><br><span class="line">    if( dwDebugPort != 0x0  )  printf(&quot;  =&gt; Debugging!!!\n\n&quot;);</span><br><span class="line">    else                       printf(&quot;  =&gt; Not debugging...\n\n&quot;);</span><br></pre></td></tr></table></figure></p>
<p>checkRemoteDebuggerPresent()API可以用来检测进程是否处于被调试状态，与IsDebuggerPresent API不同的是，它不仅可以检测当前进程是否处于被调试状态，也可检测其他进程。该函数的实现中使用了NtQueryInformationProcess(ProcessDebugPort) API</p>
<p><img src="17.png" alt=""></p>
<h2 id="ProcessDebugObjectHandle-0x1E"><a href="#ProcessDebugObjectHandle-0x1E" class="headerlink" title="ProcessDebugObjectHandle(0x1E)"></a>ProcessDebugObjectHandle(0x1E)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// ProcessDebugObjectHandle (0x1E)</span><br><span class="line">    HANDLE hDebugObject = NULL;</span><br><span class="line">    pNtQueryInformationProcess(GetCurrentProcess(),</span><br><span class="line">                               ProcessDebugObjectHandle,</span><br><span class="line">                               &amp;hDebugObject,</span><br><span class="line">                               sizeof(hDebugObject),</span><br><span class="line">                               NULL);</span><br><span class="line">    printf(&quot;NtQueryInformationProcess(ProcessDebugObjectHandle) = 0x%X\n&quot;, hDebugObject);</span><br><span class="line">    if( hDebugObject != 0x0  )  printf(&quot;  =&gt; Debugging!!!\n\n&quot;);</span><br><span class="line">    else                        printf(&quot;  =&gt; Not debugging...\n\n&quot;);</span><br></pre></td></tr></table></figure>
<p>第二个参数为ProcessDebugObjectHandle时，第三个参数返回为被调试对象句柄，当返回NULL时说明进程处于非调试状态</p>
<h2 id="ProcessDebugFlags-0x1F"><a href="#ProcessDebugFlags-0x1F" class="headerlink" title="ProcessDebugFlags(0x1F)"></a>ProcessDebugFlags(0x1F)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// ProcessDebugFlags (0x1F)</span><br><span class="line">BOOL bDebugFlag = TRUE;</span><br><span class="line">pNtQueryInformationProcess(GetCurrentProcess(),</span><br><span class="line">                           ProcessDebugFlags,</span><br><span class="line">                           &amp;bDebugFlag,</span><br><span class="line">                           sizeof(bDebugFlag),</span><br><span class="line">                           NULL);</span><br><span class="line">printf(&quot;NtQueryInformationProcess(ProcessDebugFlags) = 0x%X\n&quot;, bDebugFlag);</span><br><span class="line">if( bDebugFlag == 0x0  )  printf(&quot;  =&gt; Debugging!!!\n\n&quot;);</span><br><span class="line">else                      printf(&quot;  =&gt; Not debugging...\n\n&quot;);</span><br></pre></td></tr></table></figure>
<p>ProcessDebugFlags参数用于获取调试标识，DebugFlag的值若为0则处于调试状态，若为1则处于非调试状态</p>
<h1 id="NtQuerySytemInformation-API"><a href="#NtQuerySytemInformation-API" class="headerlink" title="NtQuerySytemInformation API"></a>NtQuerySytemInformation API</h1><p>检测系统是否以调试模式运行（WinDbg调试需要）</p>
<p>之前进程隐藏的章节中使用过ZwQuerySytemInformation API来获取进程列表，用户层Zw和Nt没什么区别，所以这里使用Zw也是可以的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS WINAPI NtQuerySystemInformation(</span><br><span class="line">  _In_      SYSTEM_INFORMATION_CLASS SystemInformationClass,</span><br><span class="line">  _Inout_   PVOID                    SystemInformation,</span><br><span class="line">  _In_      ULONG                    SystemInformationLength,</span><br><span class="line">  _Out_opt_ PULONG                   ReturnLength</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>SystemInformationClass参数中指定需要的系统信息类型，将某结构体的地址传递给SystemInformation参数，API结束时，该结构体中就填充着相关的信息</p>
<h2 id="SystemKernelDebuggerInformation-0x23"><a href="#SystemKernelDebuggerInformation-0x23" class="headerlink" title="SystemKernelDebuggerInformation(0x23)"></a>SystemKernelDebuggerInformation(0x23)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">NtQuerySystemInformation = (NTQUERYSYSTEMINFORMATION)  </span><br><span class="line">                                GetProcAddress(GetModuleHandle(L&quot;ntdll&quot;), </span><br><span class="line">                                               &quot;NtQuerySystemInformation&quot;);</span><br><span class="line"></span><br><span class="line">    ULONG SystemKernelDebuggerInformation = 0x23;</span><br><span class="line">    ULONG ulReturnedLength = 0;</span><br><span class="line">    SYSTEM_KERNEL_DEBUGGER_INFORMATION DebuggerInfo = &#123;0,&#125;;</span><br><span class="line"></span><br><span class="line">    NtQuerySystemInformation(SystemKernelDebuggerInformation, </span><br><span class="line">                             (PVOID) &amp;DebuggerInfo, </span><br><span class="line">                             sizeof(DebuggerInfo),      // 2 bytes</span><br><span class="line">                             &amp;ulReturnedLength);</span><br><span class="line"></span><br><span class="line">    printf(&quot;NtQuerySystemInformation(SystemKernelDebuggerInformation) = 0x%X 0x%X\n&quot;, </span><br><span class="line">           DebuggerInfo.DebuggerEnabled, DebuggerInfo.DebuggerNotPresent);</span><br><span class="line">    if( DebuggerInfo.DebuggerEnabled )  printf(&quot;  =&gt; Debugging!!!\n\n&quot;);</span><br><span class="line">    else                                printf(&quot;  =&gt; Not debugging...\n\n&quot;);</span><br></pre></td></tr></table></figure>
<p>DebuggerInfo.DebuggerEnabled==1时为调试状态</p>
<p>破解方法：Win XP: 编辑boot.ini 删除/debugport=com1 /baudrate=115200 /Debug</p>
<p>​ Win7: cmd执行 bcdedit /debug off</p>
<h1 id="NtQueryObject-API"><a href="#NtQueryObject-API" class="headerlink" title="NtQueryObject API"></a>NtQueryObject API</h1><p>系统中某个调试器调试进程时，会创建一个调试对象类型的内核对象。检测该对象是否存在即可判断是否有进程正在被调试</p>
<p>ntdll!NtQueryObject可获得系统各种内核对象信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS NtQueryObject(</span><br><span class="line">  _In_opt_  HANDLE                   Handle,</span><br><span class="line">  _In_      OBJECT_INFORMATION_CLASS ObjectInformationClass,</span><br><span class="line">  _Out_opt_ PVOID                    ObjectInformation,</span><br><span class="line">  _In_      ULONG                    ObjectInformationLength,</span><br><span class="line">  _Out_opt_ PULONG                   ReturnLength</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>调用NtQueryObject（）API时 先向第二个参数OBJECT_INFORMATION_CLASS ObjectInformationClass赋予某个值 调用API后 包含相关信息的结构体指针就被返回第三个参数PVOID ObjectInformation</p>
<p>OBJECT_INFORMATION_CLASS是枚举类型<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">typedef enum _OBJECT_INFORMATION_CLASS &#123; </span><br><span class="line">  ObjectBasicInformation,</span><br><span class="line">  ObjectTypeInformation,</span><br><span class="line">  ObjectNameInformation,</span><br><span class="line">  ObjectAllInformation, //3</span><br><span class="line">  ObjectHandleInformation</span><br><span class="line">&#125; OBJECT_INFORMATION_CLASS;</span><br></pre></td></tr></table></figure></p>
<p>ObjectAllInformation(0x3)<br>使用ObjectAllInformation可获得系统所有对象信息，然后从中检测是否存在调试对象</p>
<h2 id="练习：StaAD-NtQO-exe"><a href="#练习：StaAD-NtQO-exe" class="headerlink" title="练习：StaAD_NtQO.exe"></a>练习：StaAD_NtQO.exe</h2><p>在OD中按下F9运行程序StaAD_NtQO.exe<br><img src="19.png" alt=""><br><strong>破解之法</strong><br>重新载入 在401059处设置断点<br><img src="18.png" alt=""><br>位于401059处的代码是调用ntdll!NtQueryObject（）API 查看栈可以发现第二个参数的值为3 将其修改为0后运行程序  就无法探测到调试器的存在</p>
<p><img src="20.png" alt=""></p>
<h1 id="ZwSetInformationThread-API"><a href="#ZwSetInformationThread-API" class="headerlink" title="ZwSetInformationThread API"></a>ZwSetInformationThread API</h1><p>强制分离被调试者与调试者的技术，使用该API被调试者可将自身从调试器中分离出来（使调试进程终止运行，同时终止自身进程），该API不会对正常运行的程序(非调试运行)产生任何影响。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">typedef enum _THREAD_INFORMATION_CLASS &#123;</span><br><span class="line">        ThreadBasicInformation,</span><br><span class="line">        ThreadTimes,</span><br><span class="line">        ThreadPriority,</span><br><span class="line">        ThreadBasePriority,</span><br><span class="line">        ThreadAffinityMask,</span><br><span class="line">        ThreadImpersonationToken,</span><br><span class="line">        ThreadDescriptorTableEntry,</span><br><span class="line">        ThreadEnableAlignmentFaultFixup,</span><br><span class="line">        ThreadEventPair,</span><br><span class="line">        ThreadQuerySetWin32StartAddress,</span><br><span class="line">        ThreadZeroTlsCell,</span><br><span class="line">        ThreadPerformanceCount,</span><br><span class="line">        ThreadAmILastThread,</span><br><span class="line">        ThreadIdealProcessor,</span><br><span class="line">        ThreadPriorityBoost,</span><br><span class="line">        ThreadSetTlsArrayAddress,</span><br><span class="line">        ThreadIsIoPending,</span><br><span class="line">        ThreadHideFromDebugger           // 17 (0x11)</span><br><span class="line">    &#125; THREAD_INFORMATION_CLASS, *PTHREAD_INFORMATION_CLASS;</span><br><span class="line">	</span><br><span class="line">NTSTATUS ZwSetInformationThread(</span><br><span class="line">        HANDLE ThreadHandle,</span><br><span class="line">        THREAD_INFORMATION_CLASS ThreadInformationClass,</span><br><span class="line">        PVOID ThreadInformation,</span><br><span class="line">        ULONG ThreadInformationLength</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>ZwSetInformationThread(函数是一个系统原生API ( System Native API)，顾名思义，它是用来为线程设置信息的。该函数拥有2个参数，第一个参数ThreadHandle用来接收当前线程的句柄，第二个参数ThreadInformationClass表示线程信息类型，若其值设置为ThreadHideFrom-Debugger(0x11)，调用该函数后，调试进程就会被分离出来。ZwSetInformationThread( API不会对正常运行的程序(非调试运行)产生任何影响，但若运行的是调试器程序，调用该API将使调试器终止运行，同时终止自身进程。</p>
<h2 id="练习：StaAD-ZwSIT-exe"><a href="#练习：StaAD-ZwSIT-exe" class="headerlink" title="练习：StaAD_ZwSIT.exe"></a>练习：StaAD_ZwSIT.exe</h2><p>首先在OllyDbg调试器中打开示例程序StaAD_ ZwSIT.exe, 然后分别在401027与401029地址处按F2键设置断点，按F9运行程序。<br>如图所示，调试器在401027地址的断点处暂停，位于该地址处( 401027 )的CALL ESI 指令用来调用ntdll.ZwSetInformationThread( API。按F9键继续执行401027地址处的指令，这样就会分离出被调试进程并终止运行。而且，OllyDbg调试器将无法正常调试401029地址处的指令，出现运行错误。</p>
<p><img src="21.png" alt=""></p>
<h2 id="破解之法-1"><a href="#破解之法-1" class="headerlink" title="破解之法"></a>破解之法</h2><p>简单的破解思路是:调用401027地址处的ZwSetInformationThread() API前，查找存储在栈中的第二个参数ThreadInformationClass值,若其值为ThreadHideFromDebugger(0x11),则修改为0后继续运行即可</p>
<p><img src="22.png" alt=""></p>
<h1 id="TLS回调函数"><a href="#TLS回调函数" class="headerlink" title="TLS回调函数"></a>TLS回调函数</h1><p>TLS回调函数是反调试技术中常用的函数,像前面介绍的技术一样,如果不明白其工作原理，使用时就会束手无策。</p>
<p>其实，我们并不能将TLS回调本身看作- -种反调试技术，但是由于回调函数会先于EP代码执行，所以反调试技术中经常使用它。在TLS回调函数内部使用IsDebuggerPresent()等函数判断调试与否 然后再决定是否继续运行程序</p>
<h1 id="ETC"><a href="#ETC" class="headerlink" title="ETC"></a>ETC</h1><p>首先，要明白我们应用反调试技术的目的在于防止程序遭受逆向分析。不必非得为此费力判断自身进程是否处于被调试状态。-个更简单、更好的方法是,判断当前系统是否为逆向分析专用系统( 非常规系统),若是，则直接停止程序。这样就出现了各种各样的反调试技术，这些技术都能从系统中轻松获取各种信息( 进程、文件、窗口、注册表、主机名、计算机名、用户名、环境变量等)。这些反调试技术通常借助Win32API获取系统信息来具体实现。下面简单介绍几个例子</p>
<p>(1)检测OllyDbg窗口&lt;—FindWindow().</p>
<p>(2)检测OllyDbg进程&lt;—CreateToolhelp32Snapshot()</p>
<p>(3)检查计算机名称是否为“TEST” “ANALYSIS”等&lt;—GetComputerName()</p>
<p>(4)检查程序运行路径中是否存在“TEST”、“SAMPLE”等名称&lt;—GetCommandLine()。</p>
<p>(5)检测虚拟机是否处于运行状态(查看虚拟机特有的进程名称&lt;—VMWareService.exe、VMWareTray.exe、VMWareUser.exe等)</p>
<h2 id="练习：StaAD-FindWindow-exe"><a href="#练习：StaAD-FindWindow-exe" class="headerlink" title="练习：StaAD_FindWindow.exe"></a>练习：StaAD_FindWindow.exe</h2><p>首先在OllyDbg调试器中打开示例程序StaAD_FindWindow.exe F9运行</p>
<p><img src="23.png" alt=""></p>
<h2 id="破解之法-2"><a href="#破解之法-2" class="headerlink" title="破解之法"></a>破解之法</h2><p>在401023处设置断点运行<br><img src="24.png" alt=""><br>图中的代码中共有3处调用FindWindow() API。40101 E地址处的PUSH 409D10指令中，地址409D10指向Window Class名称字符串，它是FindWindow( API的第一个参数。 转到409D10地址处，使用NULL覆盖Window Class名 称字符串缓冲区，那么FindWindow( API将无法探测到相应调试器。</p>
<p>接下来使GetWindowText()API失效 在401093地址处设置好断点并运行程序</p>
<p><img src="25.png" alt=""><br>调用GetWindow TextWO API的代码在4010B4地址处。若想正常调用GetWindowTextW() API,就不能执行4010AD地址处的条件跳转指令 修改标志位的值实现跳转。要实现这一点， 可以直接操作条件跳转语句，也可以将其上GetDesktopWindow()与GetWindow() API的返回值( EAX寄存器)修改为NULL值。当然，钩取FindWindow() API与GetWindowText() API也是非常棒的方法。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/06/03/IA-32指令/" rel="next" title="IA-32指令">
                <i class="fa fa-chevron-left"></i> IA-32指令
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/06/12/动态反调试技术/" rel="prev" title="动态反调试技术">
                动态反调试技术 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">loser</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">55</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#PEB"><span class="nav-number">1.</span> <span class="nav-text">PEB</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#BeingDebugged-0x2"><span class="nav-number">1.1.</span> <span class="nav-text">BeingDebugged(+0x2)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ldr-0xC"><span class="nav-number">1.2.</span> <span class="nav-text">Ldr(+0xC)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ProcessHeap-0x18"><span class="nav-number">1.3.</span> <span class="nav-text">ProcessHeap(+0x18)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NtGlobalFlag-0x68"><span class="nav-number">1.4.</span> <span class="nav-text">NtGlobalFlag(0x68)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#练习：StaAD-PEB-exe（在WIN-XP下测试）"><span class="nav-number">1.5.</span> <span class="nav-text">练习：StaAD_PEB.exe（在WIN XP下测试）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#破解之法"><span class="nav-number">1.6.</span> <span class="nav-text">破解之法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#NtQueryInformationProcess-API"><span class="nav-number">2.</span> <span class="nav-text">NtQueryInformationProcess API</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ProcessDebugPort（0x07）"><span class="nav-number">2.1.</span> <span class="nav-text">ProcessDebugPort（0x07）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ProcessDebugObjectHandle-0x1E"><span class="nav-number">2.2.</span> <span class="nav-text">ProcessDebugObjectHandle(0x1E)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ProcessDebugFlags-0x1F"><span class="nav-number">2.3.</span> <span class="nav-text">ProcessDebugFlags(0x1F)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#NtQuerySytemInformation-API"><span class="nav-number">3.</span> <span class="nav-text">NtQuerySytemInformation API</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SystemKernelDebuggerInformation-0x23"><span class="nav-number">3.1.</span> <span class="nav-text">SystemKernelDebuggerInformation(0x23)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#NtQueryObject-API"><span class="nav-number">4.</span> <span class="nav-text">NtQueryObject API</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#练习：StaAD-NtQO-exe"><span class="nav-number">4.1.</span> <span class="nav-text">练习：StaAD_NtQO.exe</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ZwSetInformationThread-API"><span class="nav-number">5.</span> <span class="nav-text">ZwSetInformationThread API</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#练习：StaAD-ZwSIT-exe"><span class="nav-number">5.1.</span> <span class="nav-text">练习：StaAD_ZwSIT.exe</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#破解之法-1"><span class="nav-number">5.2.</span> <span class="nav-text">破解之法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TLS回调函数"><span class="nav-number">6.</span> <span class="nav-text">TLS回调函数</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ETC"><span class="nav-number">7.</span> <span class="nav-text">ETC</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#练习：StaAD-FindWindow-exe"><span class="nav-number">7.1.</span> <span class="nav-text">练习：StaAD_FindWindow.exe</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#破解之法-2"><span class="nav-number">7.2.</span> <span class="nav-text">破解之法</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">loser</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
